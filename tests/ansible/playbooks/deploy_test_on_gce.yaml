- hosts: localhost
  connection: local
  gather_facts: false
  tasks:
    - name: Get AWS facts
      aws_caller_facts:
      register: aws_facts
      tags:
        - always
    - name: Upload config to SSM
      aws_ssm_parameter_store:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        description: "Deployment Region"
        region: "{{ item.region }}"
      loop:
        - { name: /terrakvm/tf_state_bucket, value: "{{ state_bucket_name }}-{{ aws_region }}-{{ aws_facts.account }}", region: "{{ aws_region }}" }
        - { name: /terrakvm/aws_region, value: "{{ aws_region }}", region: "{{ aws_region }}" }
        - { name: /terrakvm/gce_state_file_key, value: "{{ gce_state_file_key }}", region: "{{ aws_region }}" }
        - { name: /terrakvm/gce_service_account_access_file, value: "{{ gce_service_account_access_file }}", region: "{{ aws_region }}" }
        - { name: /terrakvm/gce_compute_zone, value: "{{ gce_compute_zone }}", region: "{{ aws_region }}" }
        - { name: /terrakvm/gce_project, value: "{{ gce_project }}", region: "{{ aws_region }}" }
        - { name: /terrakvm/gce_region, value: "{{ gce_region }}", region: "{{ aws_region }}" }
    - name: Deploy Cloudformation
      cloudformation:
        stack_name: TerraKVMTestGCE
        state: present
        region: "{{ aws_region }}"
        disable_rollback: true
        template: "{{ repo_root }}/tests/aws/cloudformation/codebuild_test_on_gce.yaml" 
        template_parameters:
          ArtifactBucketName: "{{ state_bucket_name }}"
    - name: Upload access file
      aws_s3:
        bucket: "{{ state_bucket_name }}-{{ aws_region }}-{{ aws_facts.account }}"
        object: "{{ gce_service_account_access_file }}"
        src: "{{ gce_service_account_access_file_src }}"
        mode: put

        
