- hosts: localhost
  connection: local
  gather_facts: false
  vars:
    ssm_oauth_location: /TerraKVM/github-oauth
  tasks:
    - name: Update Github OAuth
      aws_ssm_parameter_store:
        name: "{{ ssm_oauth_location }}"
        value: "{{ github_oauth_token }}"
        description: "Access token to TerraKVM"
        region: "{{ aws_region }}"
      when: github_oauth_token is defined
    - name: Deploy Cloudformation
      cloudformation:
        stack_name: TerraKVMTests
        state: present
        region: "{{ aws_region }}"
        disable_rollback: true
        template: "{{ repo_root }}/tests/aws/cloudformation/terrakvm_pipeline.yml"
        template_parameters:
          GitHubOAuthToken: "{{ ssm_oauth_location }}"

        
