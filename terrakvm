#!/bin/bash
if [ -z "$SUDO_UID" ]; then
  SUDO_UID=`id -u`
  SUDO_GID=`id -g`
fi

which docker-compose > /dev/null 2>&1
if [ "$?" -ne 0 ]; then
  echo "docker-compose not in system path!"
  exit 1
fi

export SUDO_UID="$SUDO_UID"
export SUDO_GID="$SUDO_GID"
export LIBVIRT_GID=`getent group libvirt | awk -F: '{print $3}'`
export KVM_GID=`getent group kvm | awk -F: '{print $3}'`

if [ "$1" == "build" ]; then
  docker-compose run terrakvm ansible-playbook playbooks/build.yml "${@:2}"
elif [ "$1" == "apply" ]; then
  docker-compose run terrakvm ansible-playbook playbooks/apply.yml "${@:2}"
elif [ "$1" == "destroy" ]; then
  docker-compose run terrakvm ansible-playbook playbooks/destroy.yml "${@:2}"
elif [ "$1" == "up" ]; then
  docker-compose up
elif [ "$1" == "down" ]; then
  docker-compose down
else
  docker-compose "${@}"
fi
